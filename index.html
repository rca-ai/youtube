<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Trend ë¶„ì„</title>
    <!-- Tailwind CSS CDN ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Chart.js CDN ë¡œë“œ (ê·¸ë˜í”„ ì‹œê°í™”ìš©) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script> 
    <style>
        /* Inter í°íŠ¸ ì‚¬ìš© ë° ë°°ê²½ìƒ‰ ì„¤ì • */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            min-height: 100vh;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ì• ë‹ˆë©”ì´ì…˜ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* ë²„íŠ¼ ë‚´ ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner-sm {
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-left-color: #fff;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
            border-radius: 50%;
        }
        /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* ì˜ìƒ ê¸¸ì´ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        .duration-overlay {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        /* íŠ¸ë Œë“œ í•­ëª© ìŠ¤íƒ€ì¼ */
        .trend-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .trend-item:hover {
            background-color: #f9f9f9;
        }
        .trend-rank {
            width: 30px;
            font-weight: bold;
            text-align: right;
            margin-right: 12px;
            color: #3b82f6;
        }
        .trend-keyword {
            flex-grow: 1;
            font-size: 0.9rem;
            color: #1f2937;
        }
        .trend-volume {
            font-size: 0.85rem;
            color: #4b5563;
            font-weight: 600;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- API Key ì…ë ¥ ëª¨ë‹¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) -->
    <div id="apiKeyModal" class="modal-overlay hidden">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition duration-300">
            <h2 class="text-xl font-bold text-gray-800 mb-4">YouTube API í‚¤ ì…ë ¥</h2>
            <p class="text-gray-600 mb-4 text-sm">
                ì˜ìƒì„ ê²€ìƒ‰í•˜ë ¤ë©´ YouTube Data API v3 í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤. ì´ í‚¤ëŠ” Firestoreì— ì•ˆì „í•˜ê²Œ ì €ì¥ë©ë‹ˆë‹¤.
            </p>
            <input
                type="text"
                id="apiKeyInput"
                placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"
                class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
            <div id="modalMessage" class="text-sm text-red-500 mb-4 font-medium hidden"></div>
            <div class="flex justify-end gap-3">
                <button
                    id="saveApiKeyButton"
                    class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 active:scale-95"
                >
                    í‚¤ ì €ì¥ ë° ì‚¬ìš©
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- í—¤ë” ë° íƒ€ì´í‹€ -->
        <header class="text-center mb-8">
            <h1 id="mainTitle" class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2 cursor-pointer hover:text-blue-600 transition duration-150" title="í´ë¦­í•˜ì—¬ ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™">
                YouTube Trend ë¶„ì„
            </h1>
            <p class="text-gray-500">í‚¤ì›Œë“œ ë° ê³ ê¸‰ í•„í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ YouTube ì˜ìƒì„ ê²€ìƒ‰í•˜ê³  ìƒì„¸ í†µê³„ë¥¼ ë¶„ì„í•˜ì„¸ìš”.</p>
        </header>

        <!-- ê²€ìƒ‰ ë° í•„í„° ì„¹ì…˜ -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div id="loadingIndicator" class="text-center hidden mb-4">
                <div class="spinner mr-2"></div>
                <span class="text-blue-500 font-semibold">ê²€ìƒ‰ ë° ë°ì´í„° ë¶„ì„ ì¤‘... (API 2ë‹¨ê³„ ìš”ì²­)</span>
            </div>

            <p id="messageBox" class="text-sm mt-3 text-red-500 font-medium"></p>
            
            <!-- 1. í‚¤ì›Œë“œ ë° ì‹¤í–‰ ë²„íŠ¼ -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <input
                    type="text"
                    id="searchKeyword"
                    placeholder="ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì œë¯¸ë‚˜ì´ ì½”ë”©)"
                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150"
                    required
                >
                <button
                    id="searchButton"
                    class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-150 active:scale-95 disabled:bg-gray-400"
                >
                    ê²€ìƒ‰ ì‹œì‘
                </button>
                <!-- API í‚¤ ë³€ê²½ ë²„íŠ¼ ì œê±°ë¨ -->
            </div>

            <!-- 2. ê³ ê¸‰ í•„í„° ì˜µì…˜ -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm">
                
                <!-- ì •ë ¬ ë°©ì‹ -->
                <div>
                    <label for="sortBy" class="block text-gray-700 font-medium mb-1">ì •ë ¬ ê¸°ì¤€</label>
                    <select id="sortBy" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="relevance">ê´€ë ¨ì„± (ê¸°ë³¸)</option>
                        <option value="viewCount">ì¡°íšŒìˆ˜</option>
                        <option value="date">ì—…ë¡œë“œ ë‚ ì§œ</option>
                    </select>
                </div>

                <!-- ê²°ê³¼ ìˆ˜ëŸ‰ -->
                <div>
                    <label for="maxResults" class="block text-gray-700 font-medium mb-1">ê²°ê³¼ ìˆ˜</label>
                    <select id="maxResults" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="30">30ê°œ</option>
                        <option value="50" selected>50ê°œ</option>
                        <option value="100">100ê°œ</option>
                        <option value="200">200ê°œ (ì£¼ì˜: API í• ë‹¹ëŸ‰ ì†Œëª¨)</option>
                    </select>
                </div>

                <!-- ì˜ìƒ ê¸¸ì´ -->
                <div>
                    <label for="videoDuration" class="block text-gray-700 font-medium mb-1">ì˜ìƒ ê¸¸ì´</label>
                    <select id="videoDuration" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="any">ì „ì²´ (ê¸°ë³¸)</option>
                        <option value="short">ìˆì¸  (4ë¶„ ë¯¸ë§Œ)</option>
                        <option value="medium">4ë¶„ ~ 20ë¶„</option>
                        <option value="long">20ë¶„ ì´ìƒ</option>
                    </select>
                </div>

                <!-- ê¸°ê°„ (ì´ íŠ¸ë Œë“œ í•„í„°ë¡œ ì‚¬ìš©ë¨) -->
                <div>
                    <label for="dateRange" class="block text-gray-700 font-medium mb-1">ê¸°ê°„ (íŠ¸ë Œë“œ ê¸°ì¤€)</label>
                    <select id="dateRange" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="all">ì „ì²´ (ê¸°ë³¸)</option>
                        <option value="today">ì˜¤ëŠ˜</option>
                        <option value="thisWeek">ì´ë²ˆ ì£¼</option>
                        <option value="thisMonth">ì´ë²ˆ ë‹¬</option>
                        <option value="thisYear">ì´ë²ˆ ë…„</option>
                    </select>
                </div>

                <!-- ìµœì†Œ ì¡°íšŒìˆ˜ (í´ë¼ì´ì–¸íŠ¸ í•„í„°) -->
                <div>
                    <label for="minViews" class="block text-gray-700 font-medium mb-1">ìµœì†Œ ì¡°íšŒìˆ˜</label>
                    <input type="number" id="minViews" placeholder="0" value="0" min="0" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                
                <!-- ìµœì†Œ êµ¬ë…ì ìˆ˜ (í´ë¼ì´ì–¸íŠ¸ í•„í„°) -->
                <div>
                    <label for="minSubscribers" class="block text-gray-700 font-medium mb-1">ìµœì†Œ êµ¬ë…ì ìˆ˜</label>
                    <input type="number" id="minSubscribers" placeholder="0" value="0" min="0" class="w-full p-2 border border-gray-300 rounded-lg">
                </div>
                
                <!-- êµ­ê°€ (ë¦¬ì „ - ì´ íŠ¸ë Œë“œ í•„í„°ë¡œ ì‚¬ìš©ë¨) -->
                <div>
                    <label for="regionCode" class="block text-gray-700 font-medium mb-1">êµ­ê°€ (íŠ¸ë Œë“œ ê¸°ì¤€)</label>
                    <select id="regionCode" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="">ì „ì²´ (ê¸°ë³¸)</option>
                        <option value="KR">ëŒ€í•œë¯¼êµ­</option>
                        <option value="US">ë¯¸êµ­</option>
                        <option value="JP">ì¼ë³¸</option>
                        <option value="GB">ì˜êµ­</option>
                        <option value="DE">ë…ì¼</option>
                        <option value="CN">ì¤‘êµ­</option>
                        <option value="VN">ë² íŠ¸ë‚¨</option>
                        <option value="TH">íƒœêµ­</option>
                    </select>
                </div>

                <!-- íƒœê·¸ í¬í•¨/ë¶ˆí¬í•¨ ë° ìˆì¸  ì œì™¸ ì˜µì…˜ -->
                <div class="col-span-2 md:col-span-4 lg:col-span-6 flex flex-wrap gap-4 mt-3">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="tagInclusion" checked class="form-checkbox h-4 w-4 text-blue-600 rounded">
                        <span class="ml-2 text-gray-700 font-medium">ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì˜ìƒ íƒœê·¸ì— í¬í•¨í•˜ì—¬ ê²€ìƒ‰</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="excludeShorts" class="form-checkbox h-4 w-4 text-red-600 rounded">
                        <span class="ml-2 text-gray-700 font-medium">ìˆì¸  ì œì™¸ (ì„¸ë¡œ ì˜ìƒ)</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- ê¸€ë¡œë²Œ YouTube íŠ¸ë Œë“œ ë¶„ì„ ì„¹ì…˜ (ì´ˆê¸° í™”ë©´ë¶€í„° í‘œì‹œ) -->
        <div id="youtubeTrendsDashboard" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                <span id="globalTrendTitle">ê¸€ë¡œë²Œ YouTube íŠ¸ë Œë“œ ê²€ìƒ‰ ìˆœìœ„</span>
                <span id="trendFilterDisplay" class="text-sm font-medium text-blue-600">(ì „ì²´ ê¸°ê°„, ê¸€ë¡œë²Œ)</span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="trendingResultsContainer">
                <div class="md:col-span-3 text-center text-gray-500" id="initialTrendMessage">
                    í•„í„°ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ ê¸°ì¤€ì˜ íŠ¸ë Œë“œ ìˆœìœ„ (ì‹œë®¬ë ˆì´ì…˜)ê°€ í‘œì‹œë©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
        
        <!-- ê²€ìƒ‰ëŸ‰ ë¶„ì„ ë° ì—°ê´€ í‚¤ì›Œë“œ ì„¹ì…˜ (ê²€ìƒ‰ í›„ í‘œì‹œ) -->
        <div id="searchVolumeAnalysis" class="hidden bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                <span id="analysisTitle">í‚¤ì›Œë“œ ê²€ìƒ‰ëŸ‰ ë° ì—°ê´€ ë¶„ì„ ê²°ê³¼ (ì‹œë®¬ë ˆì´ì…˜ - ì›”ê°„)</span>
                <div class="flex items-center space-x-2">
                    <label for="trendRange" class="text-sm font-medium text-gray-700">ì¶”ì´:</label>
                    <select id="trendRange" class="p-1 border border-gray-300 rounded-lg text-sm bg-gray-50">
                        <option value="weekly">ì£¼ê°„</option>
                        <option value="monthly" selected>ì›”ê°„</option>
                        <option value="yearly">ë…„ê°„</option>
                    </select>
                </div>
            </h2>

            <!-- ì—°ê´€ í‚¤ì›Œë“œ í‘œì‹œ -->
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm font-semibold text-gray-700 mb-1 flex items-center">
                    ì—°ê´€ ê²€ìƒ‰ í‚¤ì›Œë“œ (Gemini ë¶„ì„): 
                    <span id="relatedKeywordsLoading" class="hidden ml-2 spinner-sm border-blue-600 border-l-transparent"></span>
                </p>
                <div id="relatedKeywordsList" class="flex flex-wrap gap-2 text-sm">
                    <!-- ì—°ê´€ í‚¤ì›Œë“œê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ê²€ìƒ‰ëŸ‰ ì¶”ì´ ê·¸ë˜í”„ -->
            <div class="h-64">
                <canvas id="searchVolumeChart"></canvas>
            </div>
        </div>


        <!-- ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div id="searchResultsContainer" class="hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                <span id="resultCountHeader">ê²€ìƒ‰ ê²°ê³¼ (0ê°œ)</span>
                <!-- ì œëª© ì „ì²´ ë²ˆì—­ ë²„íŠ¼ ì¶”ê°€ -->
                <button
                    id="translateAllButton"
                    class="bg-indigo-500 text-white text-sm font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 active:scale-95 disabled:bg-gray-400 flex items-center"
                >
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M3 9h9m-9 4h6m4 0h6m-6 0v-4m0 0h6m-6 0L14 3m0 0l-2 2m2-2v4"></path></svg>
                    <span id="translateAllText">ì œëª© ì „ì²´ ë²ˆì—­</span>
                </button>
            </h2>
            <div id="resultsList" class="space-y-4">
                <!-- ì—¬ê¸°ì— ê²€ìƒ‰ ê²°ê³¼ ì¹´ë“œê°€ ì‚½ì…ë©ë‹ˆë‹¤. -->
            </div>
        </div>
    </div>

    <!-- JavaScript ë¡œì§ (type="module"ë¡œ ë³€ê²½í•˜ì—¬ Firebase Import ê°€ëŠ¥) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore ë¡œê¹… í™œì„±í™” (ë””ë²„ê¹… ëª©ì )
        setLogLevel('debug');

        // GitHub/ì™¸ë¶€ í™˜ê²½ì—ì„œ Firebaseë¥¼ ì´ˆê¸°í™”í•˜ê¸° ìœ„í•œ ë”ë¯¸ ì„¤ì • ë˜ëŠ” ì‚¬ìš©ì ì…ë ¥ ì„¤ì •
        const dummyFirebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY", // ì‹¤ì œ í‚¤ë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };


        // Global variables provided by the Canvas environment (with fallback for external hosting)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // __firebase_configê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ê±°ë‚˜ íŒŒì‹±ì— ì‹¤íŒ¨í•˜ë©´ dummyFirebaseConfigë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        const firebaseConfig = (() => {
            try {
                return typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : dummyFirebaseConfig;
            } catch (e) {
                console.warn("Failed to parse __firebase_config. Using dummy configuration.", e);
                return dummyFirebaseConfig;
            }
        })();
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'anonymous'; 
        
        // NOTE: The user has requested to hardcode this key for testing purposes to bypass immediate API key input errors.
        const DEFAULT_YOUTUBE_API_KEY = 'AIzaSyDe0emcV4KC675d04fgKn1bmFPdXldpdxE';
        let youtubeApiKey = DEFAULT_YOUTUBE_API_KEY; // Pre-fill with the user-provided key

        // DOM ìš”ì†Œ ìºì‹œ
        const mainTitle = document.getElementById('mainTitle');
        const searchKeywordInput = document.getElementById('searchKeyword');
        const searchButton = document.getElementById('searchButton');
        // const openModalButton = document.getElementById('openModalButton'); // API í‚¤ ë³€ê²½ ë²„íŠ¼ ì œê±°ë¨
        const messageBox = document.getElementById('messageBox');
        const loadingIndicator = document.getElementById('loadingIndicator');

        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyButton = document.getElementById('saveApiKeyButton');
        const modalMessage = document.getElementById('modalMessage');

        const resultsList = document.getElementById('resultsList');
        const searchResultsContainer = document.getElementById('searchResultsContainer');
        const resultCountHeader = document.getElementById('resultCountHeader');
        
        // í•„í„° ìš”ì†Œ ìºì‹œ
        const sortBySelect = document.getElementById('sortBy');
        const maxResultsSelect = document.getElementById('maxResults');
        const videoDurationSelect = document.getElementById('videoDuration');
        const dateRangeSelect = document.getElementById('dateRange'); // íŠ¸ë Œë“œ ê¸°ê°„ í•„í„°ë¡œë„ ì‚¬ìš©
        const minViewsInput = document.getElementById('minViews');
        const minSubscribersInput = document.getElementById('minSubscribers'); // ìµœì†Œ êµ¬ë…ì ìˆ˜
        const regionCodeSelect = document.getElementById('regionCode'); // íŠ¸ë Œë“œ êµ­ê°€ í•„í„°ë¡œë„ ì‚¬ìš©
        const tagInclusionCheckbox = document.getElementById('tagInclusion');
        const excludeShortsCheckbox = document.getElementById('excludeShorts'); // ìˆì¸  ì œì™¸
        
        // ìƒˆë¡œìš´ ìš”ì†Œ ìºì‹œ (ê²€ìƒ‰ëŸ‰ ë¶„ì„ ê´€ë ¨)
        const searchVolumeAnalysis = document.getElementById('searchVolumeAnalysis');
        const trendRangeSelect = document.getElementById('trendRange');
        const relatedKeywordsList = document.getElementById('relatedKeywordsList');
        const relatedKeywordsLoading = document.getElementById('relatedKeywordsLoading');
        const analysisTitle = document.getElementById('analysisTitle');
        
        // ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ìš”ì†Œ ìºì‹œ
        const youtubeTrendsDashboard = document.getElementById('youtubeTrendsDashboard');
        const trendingResultsContainer = document.getElementById('trendingResultsContainer');
        const globalTrendTitle = document.getElementById('globalTrendTitle');
        const trendFilterDisplay = document.getElementById('trendFilterDisplay');
        const initialTrendMessage = document.getElementById('initialTrendMessage');
        const translateAllButton = document.getElementById('translateAllButton'); // ì œëª© ì „ì²´ ë²ˆì—­ ë²„íŠ¼
        const translateAllText = document.getElementById('translateAllText'); 
        
        let searchVolumeChartInstance = null; // Chart.js ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let currentKeyword = ''; // í˜„ì¬ ê²€ìƒ‰ëœ í‚¤ì›Œë“œë¥¼ ì €ì¥í•  ë³€ìˆ˜
        
        // =================================================================
        // êµ­ê°€ ì½”ë“œ ë§¤í•‘ì€ 2ìë¦¬ ì½”ë“œ ì‚¬ìš©ì„ ìœ„í•´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
        // =================================================================


        // =================================================================
        // Firebase ë° API Key ê´€ë¦¬ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
        // =================================================================
        
        async function initializeFirebase() {
            // ì™¸ë¶€ í˜¸ìŠ¤íŒ… ì‹œ, dummyFirebaseConfigì— ì‹¤ì œ ê°’ì´ ì…ë ¥ë˜ì§€ ì•Šìœ¼ë©´ Firestore ê¸°ëŠ¥ ì‚¬ìš© ë¶ˆê°€ ê²½ê³ 
            if (firebaseConfig === dummyFirebaseConfig && firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY") {
                console.warn("ğŸš¨ Firebase ì„¤ì •ì´ ê¸°ë³¸ê°’ì…ë‹ˆë‹¤. í‚¤ ì €ì¥ ê¸°ëŠ¥ì€ Canvas ì™¸ë¶€ì—ì„œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                messageBox.textContent = "Firebase ì„¤ì •ì´ ê¸°ë³¸ê°’ì…ë‹ˆë‹¤. API í‚¤ ì €ì¥ì„ ìœ„í•´ì„œëŠ” Firebase ì„¤ì •ì„ ì§ì ‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.";
                
                // Canvas ì™¸ë¶€ì—ì„œëŠ” ì¸ì¦ì´ ì„±ê³µí•˜ì§€ ëª»í•˜ë¯€ë¡œ ìµëª…ìœ¼ë¡œ ê°•ì œ ì„¤ì •
                userId = crypto.randomUUID(); // ê³ ìœ  IDë¡œ ì„¤ì •í•˜ì—¬ í‚¤ ì €ì¥ì†Œ ê²½ë¡œë§Œ ìƒì„±
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // initialAuthTokenì´ ìˆì„ ë•Œë§Œ Custom Token ì¸ì¦ ì‹œë„ (Canvas í™˜ê²½)
                // ì—†ì„ ê²½ìš° ìµëª… ì¸ì¦ ì‹œë„ (ì™¸ë¶€ í™˜ê²½, í˜¹ì€ ì¸ì¦ í† í° ì—†ëŠ” ê²½ìš°)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                if (auth.currentUser) {
                    userId = auth.currentUser.uid;
                    console.log("Firebase initialized and user signed in. UID:", userId);
                    await loadApiKey();
                } else {
                    // ìµëª… ì¸ì¦ë„ ì‹¤íŒ¨í•˜ë©´ userIdë¥¼ ì„ì‹œ ê³ ìœ  IDë¡œ ìœ ì§€
                    console.warn("Firebase initialized, but no user is signed in. Using temporary UUID for storage context.");
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                // Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ ë°•ìŠ¤ì— ì¶œë ¥
                messageBox.textContent = "Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í‚¤ ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.";
            }
            
            // ì´ˆê¸° ë¡œë“œ ì‹œ ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ë°ì´í„° í‘œì‹œ (ê²€ìƒ‰ í‚¤ì›Œë“œ ì—†ìŒ)
            fetchAndRenderTrends(''); 
        }
        
        async function loadApiKey() {
            if (!db || !userId) return;
            const keyDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/youtube_api_key`);
            try {
                const docSnap = await getDoc(keyDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    youtubeApiKey = data.key; // Load from Firestore if exists
                    messageBox.textContent = "âœ… ì €ì¥ëœ API í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì•±ì„ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.";
                    console.log("API Key loaded successfully from Firestore.");
                } else {
                    console.log("No stored API Key found. Using default hardcoded key.");
                    // ìš”ì²­ì— ë”°ë¼ ì´ˆê¸° ê²½ê³  ë©”ì‹œì§€ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                    // messageBox.textContent = "â„¹ï¸ ì €ì¥ëœ í‚¤ê°€ ì—†ì–´ ê¸°ë³¸ API í‚¤ë¡œ ì‘ë™ì„ ì‹œì‘í•©ë‹ˆë‹¤.";
                }
            } catch (e) {
                console.error("Error loading API key from Firestore:", e);
                // ìš”ì²­ì— ë”°ë¼ ì´ˆê¸° ê²½ê³  ë©”ì‹œì§€ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                // messageBox.textContent = "âš ï¸ ì €ì¥ëœ API í‚¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê¸°ë³¸ API í‚¤ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.";
            }
        }

        async function saveApiKey(key) {
            if (!db || !userId || !key) {
                modalMessage.textContent = "ì €ì¥ ì˜¤ë¥˜: ë°ì´í„°ë² ì´ìŠ¤ ë˜ëŠ” ì‚¬ìš©ì IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                modalMessage.classList.remove('hidden');
                return;
            }

            const keyDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/youtube_api_key`);
            
            try {
                await setDoc(keyDocRef, { key: key, savedAt: new Date().toISOString() });
                youtubeApiKey = key;
                apiKeyModal.classList.add('hidden');
                modalMessage.classList.add('hidden');
                messageBox.textContent = "âœ… API í‚¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
                console.log("API Key saved successfully to Firestore.");
            } catch (e) {
                console.error("Error saving API key:", e);
                modalMessage.textContent = `í‚¤ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}. Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
                modalMessage.classList.remove('hidden');
            }
        }
        
        function showApiKeyModal(show) {
            if (show) {
                // í˜„ì¬ youtubeApiKey ê°’ì„ ì…ë ¥ í•„ë“œì— ìë™ ì±„ì›€ (ê¸°ë³¸ê°’ ë˜ëŠ” Firestoreì—ì„œ ë¡œë“œëœ ê°’)
                if (youtubeApiKey !== '') {
                    apiKeyInput.value = youtubeApiKey;
                }
                apiKeyModal.classList.remove('hidden');
                apiKeyInput.focus();
            } else {
                apiKeyModal.classList.add('hidden');
            }
        }

        // =================================================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        // =================================================================

        /**
         * ìˆ«ìë¥¼ ì²œ ë‹¨ìœ„ êµ¬ë¶„ ê¸°í˜¸ê°€ ìˆëŠ” ë¬¸ìì—´ë¡œ í¬ë§·í•©ë‹ˆë‹¤.
         */
        function formatNumber(num) {
            if (num === undefined || num === null) return 'N/A';
            const numberValue = Number(num) || 0; 
            return numberValue.toLocaleString('ko-KR');
        }

        /**
         * ISO 8601 Duration ë¬¸ìì—´ì„ ì‹œê³„ì—´ í¬ë§· (HH:MM:SS)ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         * ì˜ˆ: PT1H30M15S -> 1:30:15
         */
        function formatDuration(iso8601) {
            if (!iso8601) return 'N/A';
            const match = iso8601.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
            if (!match) return 'N/A';

            const hours = parseInt(match[1]) || 0;
            const minutes = parseInt(match[2]) || 0;
            const seconds = parseInt(match[3]) || 0;

            const pad = (num) => String(num).padStart(2, '0');

            if (hours > 0) {
                return `${hours}:${pad(minutes)}:${pad(seconds)}`;
            } else {
                return `${minutes}:${pad(seconds)}`;
            }
        }

        /**
         * ì„ íƒëœ ê¸°ê°„ì— ë”°ë¼ ISO 8601 í˜•ì‹ì˜ 'publishedAfter' ë‚ ì§œë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
         * @returns {string | undefined} ISO 8601 ë‚ ì§œ ë˜ëŠ” undefined
         */
        function calculatePublishedAfter(range) {
            const now = new Date();
            let date = new Date(now);

            switch (range) {
                case 'today':
                    date.setHours(0, 0, 0, 0); // ì˜¤ëŠ˜ 0ì‹œ
                    break;
                case 'thisWeek':
                    date.setDate(now.getDate() - now.getDay()); // ì´ë²ˆ ì£¼ ì¼ìš”ì¼ (ì‹œì‘ì¼)
                    date.setHours(0, 0, 0, 0);
                    break;
                case 'thisMonth':
                    date.setDate(1); // ì´ë²ˆ ë‹¬ 1ì¼
                    date.setHours(0, 0, 0, 0);
                    break;
                case 'thisYear':
                    date.setMonth(0, 1); // ì´ë²ˆ ë…„ë„ 1ì›” 1ì¼
                    date.setHours(0, 0, 0, 0);
                    break;
                default:
                    return undefined;
            }
            return date.toISOString().split('.')[0] + 'Z'; // ISO 8601 í¬ë§·
        }

        /**
         * UI ìƒíƒœë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         * @param {boolean} isLoading
         */
        function setUIState(isLoading) {
            searchButton.disabled = isLoading;
            // openModalButton.disabled = isLoading; // API í‚¤ ë³€ê²½ ë²„íŠ¼ ì œê±°ë¡œ ì¸í•´ ì£¼ì„ ì²˜ë¦¬
            loadingIndicator.classList.toggle('hidden', !isLoading);
        }

        // =================================================================
        // Gemini API ë¡œì§ (ë²ˆì—­, ìš”ì•½, ì—°ê´€ í‚¤ì›Œë“œ, ë‹¤êµ­ì–´ ê°ì§€)
        // =================================================================
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';

        /**
         * Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (Exponential Backoff ì ìš©)
         * @param {string} prompt - LLMì— ì „ë‹¬í•  ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸
         * @param {string} systemInstruction - LLMì˜ ì—­í• ì„ ì •ì˜í•˜ëŠ” ì‹œìŠ¤í…œ ì§€ì¹¨
         * @returns {Promise<string>} ìƒì„±ëœ í…ìŠ¤íŠ¸
         */
        async function callGeminiApi(prompt, systemInstruction) {
            if (!youtubeApiKey || youtubeApiKey.length < 20) {
                 return "[API ì˜¤ë¥˜: Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í‚¤ë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ ì£¼ì„¸ìš”.]";
            }
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            const url = GEMINI_API_URL + youtubeApiKey;
            const MAX_RETRIES = 3; 
            let lastErrorMessage = '';

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMessage = errorData.error?.message || `API call failed with status: ${response.status}`;
                        lastErrorMessage = errorMessage;
                        
                        // Check for transient errors (Overloaded, Too Many Requests, Server Error, Quota Exceeded)
                        if (response.status === 429 || 
                            response.status >= 500 || // 5xx server errors often temporary
                            errorMessage.includes("overloaded") || 
                            errorMessage.includes("rate limit") ||
                            errorMessage.includes("Quota exceeded")) {

                            // Transient error: proceed to retry
                            if (attempt < MAX_RETRIES - 1) {
                                // Exponential Backoff with Jitter
                                const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000); 
                                console.warn(`Transient API error (Attempt ${attempt + 1}/${MAX_RETRIES}). Retrying in ${Math.round(delay/1000)}s...`);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue; // Skip to next iteration (retry)
                            } else {
                                // Max retries reached
                                throw new Error(errorMessage); 
                            }
                        } else {
                            // Non-transient error (e.g., 400 Bad Request, 403 Forbidden - requires user action)
                            throw new Error(errorMessage);
                        }
                    }

                    // Success
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                    return text.trim();

                } catch (error) {
                    // Catch network errors or specific errors thrown above
                    if (attempt < MAX_RETRIES - 1 && (error.message.includes("Failed to fetch") || error.message.includes("overloaded"))) {
                        // For network errors or if we missed an overload error, retry (though status check is better)
                        const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000); 
                        console.warn(`Network/Transient API error (Attempt ${attempt + 1}/${MAX_RETRIES}). Retrying in ${Math.round(delay/1000)}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        // Re-throw if max retries reached or it's a critical error
                        lastErrorMessage = lastErrorMessage || error.message;
                        break; // Exit loop to handle final error
                    }
                }
            }
            
            // Final error handling after retry loop
            console.error("Gemini API Error (Final):", lastErrorMessage);
            let cleanMessage = lastErrorMessage.replace(/^Error:\s*/, '');
            return `[API ì˜¤ë¥˜: ${cleanMessage}]`;
        }

        /**
         * ê²€ìƒ‰ í‚¤ì›Œë“œì˜ ì£¼ìš” ì–¸ì–´ë¥¼ ê°ì§€í•©ë‹ˆë‹¤.
         * @param {string} keyword - ê²€ìƒ‰ í‚¤ì›Œë“œ
         * @returns {string} ê°ì§€ëœ ì–¸ì–´ (ì˜ˆ: Korean, English, Chinese ë“±)
         */
        async function detectKeywordLanguage(keyword) {
            const systemPrompt = "You are a language detection expert. Your only task is to identify the primary language of the input text. Respond with only the language name (e.g., Korean, English, Japanese). If the language is ambiguous or mixed, default to English.";
            const userPrompt = `Identify the primary language of the following keyword: "${keyword}"`;
            
            try {
                const language = await callGeminiApi(userPrompt, systemPrompt);
                // API ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ Englishë¥¼ ë°˜í™˜
                if (language.startsWith('[API ì˜¤ë¥˜')) {
                    return 'English';
                }
                return language.trim();
            } catch (error) {
                console.error("Language detection failed:", error);
                return 'English';
            }
        }
        
        // =================================================================
        // íŠ¸ë Œë“œ ê²€ìƒ‰ ìˆœìœ„ ë¡œì§ (ì‹œë®¬ë ˆì´ì…˜)
        // =================================================================
        
        // êµ­ê°€ ì´ë¦„ ë§¤í•‘ (íŠ¸ë Œë“œ í‘œì‹œìš©)
        const REGION_NAMES = {
            'KR': 'ëŒ€í•œë¯¼êµ­', 'US': 'ë¯¸êµ­', 'JP': 'ì¼ë³¸', 'GB': 'ì˜êµ­', 'DE': 'ë…ì¼', 
            'CN': 'ì¤‘êµ­', 'VN': 'ë² íŠ¸ë‚¨', 'TH': 'íƒœêµ­', '': 'ê¸€ë¡œë²Œ'
        };
        
        const TIME_RANGE_NAMES = {
            'today': 'ì˜¤ëŠ˜', 'thisWeek': 'ì´ë²ˆ ì£¼', 'thisMonth': 'ì´ë²ˆ ë‹¬', 
            'thisYear': 'ì´ë²ˆ ë…„', 'all': 'ì „ì²´ ê¸°ê°„'
        };

        /**
         * ì„ì˜ì˜ ë‹¨ì¼ ê²€ìƒ‰ëŸ‰ ê°’ì„ ìƒì„±í•©ë‹ˆë‹¤. (ì‹œë®¬ë ˆì´ì…˜)
         */
        function generateSimulatedVolume(keyword, range) {
            // í‚¤ì›Œë“œ ê¸¸ì´ì— ë”°ë¥¸ ì‘ì€ ë³€ë™ì„±ì„ ë¶€ì—¬ (ê¸´ í‚¤ì›Œë“œëŠ” ì¡°ê¸ˆ ë‚®ì€ ê¸°ë³¸ê°’)
            const lengthFactor = 1 - Math.min(keyword.length / 50, 0.5); 
            let baseValue = (Math.floor(Math.random() * 5000) + 5000) * lengthFactor; 
            
            // ê¸°ê°„ë³„ ë°°ìœ¨ ì¡°ì •
            if (range === 'weekly' || range === 'thisWeek') {
                baseValue = baseValue / 4; 
            } else if (range === 'yearly' || range === 'thisYear') {
                baseValue = baseValue * 10;
            }
            
            // ìµœì¢… ë‚œìˆ˜ ë…¸ì´ì¦ˆ ì¶”ê°€
            let volume = baseValue + (Math.random() - 0.5) * baseValue * 0.3;
            
            return Math.max(100, Math.round(volume));
        }
        
        /**
         * ì„ì˜ì˜ íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (YouTube APIëŠ” ì´ ë°ì´í„°ë¥¼ ì œê³µí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì‹œë®¬ë ˆì´ì…˜)
         * @param {string} regionCode - êµ­ê°€ ì½”ë“œ
         * @param {string} timeRange - ì‹œê°„ ë²”ìœ„
         * @param {string} searchKeyword - ê²€ìƒ‰ í‚¤ì›Œë“œ (ì—°ê´€ì„± ë¶€ì—¬ìš©)
         */
        function generateTrendingData(regionCode, timeRange, searchKeyword = '') {
            const trends = [];
            
            // êµ­ê°€ ë° ê¸°ê°„ë³„ íŠ¹í™”ëœ ì‹œë®¬ë ˆì´ì…˜ í‚¤ì›Œë“œ ëª©ë¡
            let baseKeywords = [
                "2025ë…„ IT íŠ¸ë Œë“œ ë¶„ì„", "Gemini API ì½”ë”© ë¹„ë²•", "ìµœì‹  ì¸ê³µì§€ëŠ¥ ê¸°ìˆ ", "ì£¼ì‹ ì‹œì¥ ë‹¨íƒ€ ì „ëµ",
                "K-POP ì‹ ê³¡ ë®¤ì§ë¹„ë””ì˜¤", "ìœ ëŸ½ ë‚­ë§Œ ì—¬í–‰ vlog", "ì§‘ì—ì„œ 10ë¶„ ì¹¼ë¡œë¦¬ ì†Œëª¨", "ì—ì–´í”„ë¼ì´ì–´ ë§ŒëŠ¥ ë ˆì‹œí”¼",
                "ë¶€ë™ì‚° ê²½ë§¤ ê¸°ë³¸", "ì´ˆë³´ìë¥¼ ìœ„í•œ ì˜ì–´ íšŒí™”", "ë°ì´í„° ë¶„ì„ ìê²©ì¦", "ì¸ê¸° ì›¹íˆ° ê²°ë§ ë¶„ì„",
                "20ëŒ€ ì¬í…Œí¬ í•„ìˆ˜", "ê°“ìƒ ë£¨í‹´ ë§Œë“¤ê¸°", "íë§ ASMR ìˆ˜ë©´ ìœ ë„", "í¸ì•ˆí•œ ëª…ìƒ ìŒì•…",
                "ê°¤ëŸ­ì‹œ S26 ìŠ¤í™ ìœ ì¶œ", "ì•„ì´í° 17 ì˜ˆìƒ ë””ìì¸", "ë¯¸ë‹ˆë©€ íŒ¨ì…˜ ìŠ¤íƒ€ì¼ë§", "ì „ê¸°ì°¨ ì¶©ì „ì†Œ ìœ„ì¹˜"
            ];

            // ê²€ìƒ‰ í‚¤ì›Œë“œê°€ ìˆëŠ” ê²½ìš°, í•´ë‹¹ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ì—¬ ê´€ë ¨ì„±ì„ ë†’ì…ë‹ˆë‹¤.
            if (searchKeyword) {
                 // í‚¤ì›Œë“œì™€ ê´€ë ¨ëœ 5ê°œì˜ í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                 const relatedSimulations = [
                    `${searchKeyword} ë¶„ì„`,
                    `${searchKeyword} ê³µëµ`,
                    `${searchKeyword} ê¿€íŒ`,
                    `2025ë…„ ${searchKeyword} ì „ë§`,
                    `ì´ˆë³´ì ${searchKeyword} ê°€ì´ë“œ`
                 ];
                 // ê¸°ì¡´ ëª©ë¡ì— ì„ê³  ì¤‘ë³µ ì œê±°
                 baseKeywords = [...new Set([...relatedSimulations, ...baseKeywords])];
            }


            const popularKeywords = baseKeywords.sort(() => 0.5 - Math.random()); // ë¬´ì‘ìœ„ë¡œ ì„ê¸°
            
            popularKeywords.slice(0, 20).forEach((keyword, index) => {
                let score = (20 - index) * 1000 + Math.floor(Math.random() * 500);
                
                // ì§€ì—­/ì‹œê°„ ê°€ì¤‘ì¹˜ ì‹œë®¬ë ˆì´ì…˜
                if (regionCode === 'KR' && (keyword.includes('K-POP') || keyword.includes('ì£¼ì‹') || keyword.includes('ë¶€ë™ì‚°'))) score *= 1.5;
                if (regionCode === 'US' && (keyword.includes('IT') || keyword.includes('AI'))) score *= 1.4;
                if (timeRange === 'thisWeek' || timeRange === 'today') score *= 1.2;
                if (timeRange === 'thisYear') score *= 0.8;
                
                // ê²€ìƒ‰ í‚¤ì›Œë“œì™€ ê´€ë ¨ëœ ê²½ìš° ì ìˆ˜ ì¶”ê°€ ë¶€ì—¬
                if (searchKeyword && keyword.includes(searchKeyword)) score *= 1.8;
                
                trends.push({
                    rank: index + 1,
                    keyword: keyword,
                    score: Math.round(score),
                    volume: generateSimulatedVolume(keyword, timeRange) // ë³¼ë¥¨ ê°’ ì¶”ê°€
                });
            });

            // ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ìµœì¢… ìˆœìœ„ ê²°ì •
            return trends.sort((a, b) => b.score - a.score).map((item, index) => ({
                ...item,
                rank: index + 1 // ì¬ì •ë ¬ëœ ìˆœìœ„
            }));
        }

        /**
         * ê¸€ë¡œë²Œ íŠ¸ë Œë“œ í‚¤ì›Œë“œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderTrendingKeywords(trends) {
            trendingResultsContainer.innerHTML = '';
            initialTrendMessage.classList.add('hidden');
            
            if (trends.length === 0) {
                 trendingResultsContainer.innerHTML = '<div class="md:col-span-3 text-center text-gray-500 p-4">íŠ¸ë Œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ë³€ê²½í•´ë³´ì„¸ìš”.</div>';
                 return;
            }

            trends.forEach(item => {
                const trendItemHtml = `
                    <div 
                        class="trend-item bg-white rounded-lg shadow-sm hover:shadow-md transition duration-150 p-3"
                        data-tag-value="${item.keyword.replace(/"/g, '&quot;')}"
                    >
                        <span class="trend-rank text-lg">${item.rank}</span>
                        <span class="trend-keyword">${item.keyword}</span>
                        <span class="trend-volume">${formatNumber(item.volume)}íšŒ</span>
                    </div>
                `;
                trendingResultsContainer.insertAdjacentHTML('beforeend', trendItemHtml);
            });
        }
        
        /**
         * í•„í„° ì„¤ì •ì— ë”°ë¼ íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë Œë”ë§í•˜ê³  UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * @param {string} [keyword=''] - ê²€ìƒ‰ í‚¤ì›Œë“œ (ì„ íƒì )
         */
        function fetchAndRenderTrends(keyword = '') {
            const regionCode = regionCodeSelect.value;
            const dateRange = dateRangeSelect.value;
            
            // í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ íŠ¸ë Œë“œ ì„¹ì…˜ ì œëª© ë³€ê²½
            const regionName = REGION_NAMES[regionCode] || 'ì „ì²´';
            const rangeName = TIME_RANGE_NAMES[dateRange] || 'ì „ì²´ ê¸°ê°„';

            if (keyword) {
                globalTrendTitle.textContent = `í‚¤ì›Œë“œ "${keyword}" ì—°ê´€ íŠ¸ë Œë“œ ìˆœìœ„`;
                trendFilterDisplay.textContent = `(${rangeName}, ${regionName} ê¸°ì¤€)`;
            } else {
                globalTrendTitle.textContent = `ê¸€ë¡œë²Œ YouTube íŠ¸ë Œë“œ ê²€ìƒ‰ ìˆœìœ„`;
                trendFilterDisplay.textContent = `(${rangeName}, ${regionName} ê¸°ì¤€)`;
            }
            
            const trends = generateTrendingData(regionCode, dateRange, keyword);
            renderTrendingKeywords(trends);
        }


        /**
         * ê²€ìƒ‰ëŸ‰ ì¶”ì´ ë²”ìœ„ ë³€ê²½ ì‹œ ì´ë¯¸ í‘œì‹œëœ ì—°ê´€ í‚¤ì›Œë“œì˜ ë³¼ë¥¨ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateRelatedKeywordVolumes(range) {
            const buttons = relatedKeywordsList.querySelectorAll('.tag-search-btn');
            
            buttons.forEach(button => {
                const keyword = button.dataset.tagValue;
                const newVolume = generateSimulatedVolume(keyword, range);
                
                // ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
                button.dataset.keywordVolume = newVolume;
                
                // UI ì—…ë°ì´íŠ¸
                const volumeSpan = button.querySelector('span');
                if (volumeSpan) {
                    volumeSpan.textContent = `${formatNumber(newVolume)}íšŒ`;
                }
            });

            // ê²€ìƒ‰ëŸ‰ ì„¹ì…˜ì˜ ì œëª© ì—…ë°ì´íŠ¸
            const rangeText = trendRangeSelect.options[trendRangeSelect.selectedIndex].text;
            analysisTitle.textContent = `í‚¤ì›Œë“œ ê²€ìƒ‰ëŸ‰ ë° ì—°ê´€ ë¶„ì„ ê²°ê³¼ (ì‹œë®¬ë ˆì´ì…˜ - ${rangeText})`;
        }

        // =================================================================
        // í´ë¦½ë³´ë“œ ë³µì‚¬ ë¡œì§
        // =================================================================

        /**
         * íƒœê·¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í•˜ê³  í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.
         * (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
         */
        function copyTagsToClipboard(tagsString, buttonElement) {
            const tempInput = document.createElement('textarea');
            tempInput.value = tagsString;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            let success = false;
            try {
                // document.execCommand('copy')ëŠ” iframe í™˜ê²½ì—ì„œ ë³µì‚¬ì— ê°€ì¥ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Clipboard copy failed:', err);
            }
            
            document.body.removeChild(tempInput);

            // í”¼ë“œë°± ì œê³µ
            const originalText = buttonElement.textContent;
            const originalClasses = buttonElement.className;

            if (success) {
                buttonElement.textContent = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
                buttonElement.className = originalClasses.replace('bg-green-500', 'bg-lime-600').replace('bg-red-600', 'bg-lime-600');
            } else {
                buttonElement.textContent = 'âŒ ë³µì‚¬ ì‹¤íŒ¨!';
                buttonElement.className = originalClasses.replace('bg-green-500', 'bg-red-600').replace('bg-lime-600', 'bg-red-600');
            }

            // 2ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.className = originalClasses;
            }, 2000);
        }
        
        // =================================================================
        // ê²€ìƒ‰ëŸ‰ ì¶”ì´ ê·¸ë˜í”„ (Chart.js)
        // =================================================================

        /**
         * ì„ì˜ì˜ ê²€ìƒ‰ëŸ‰ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ì‹¤ì œ API ë¯¸ì§€ì›ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜)
         */
        function generateTrendData(range) {
            let count;
            let labels;
            let data = [];
            const baseValue = Math.floor(Math.random() * 5000) + 5000; // 5000~10000 ì‚¬ì´

            if (range === 'weekly') {
                count = 7;
                labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            } else if (range === 'yearly') {
                count = 12;
                labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            } else { // monthly (default)
                count = 4;
                labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            }

            // Simulating a slightly rising/falling trend with noise
            let currentValue = baseValue;
            for (let i = 0; i < count; i++) {
                // Apply a small random variation (up to +/- 20% of base value)
                currentValue = currentValue + (Math.random() - 0.5) * baseValue * 0.2;
                data.push(Math.max(0, Math.round(currentValue))); // Ensure positive
            }

            return { labels, data };
        }

        /**
         * ê²€ìƒ‰ëŸ‰ ì¶”ì´ ê·¸ë˜í”„ë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderSearchTrendGraph(keyword, range) {
            const ctx = document.getElementById('searchVolumeChart').getContext('2d');
            const { labels, data } = generateTrendData(range);

            if (searchVolumeChartInstance) {
                searchVolumeChartInstance.destroy();
            }

            searchVolumeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${keyword} ê²€ìƒ‰ëŸ‰ ì¶”ì´ (${range})`,
                        data: data,
                        borderColor: 'rgb(59, 130, 246)', // blue-500
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: 'rgb(37, 99, 235)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'ê²€ìƒ‰ëŸ‰ (ì‹œë®¬ë ˆì´ì…˜)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatNumber(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        // =================================================================
        // ê²€ìƒ‰ ë° ë¶„ì„ ë¡œì§ (3ë‹¨ê³„ ìš”ì²­)
        // =================================================================

        /**
         * YouTube ê²€ìƒ‰ API (Step 1)ë¥¼ í˜¸ì¶œí•˜ê³ , ê·¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ Videos API (Step 2), Channels API (Step 3)ë¥¼ í˜¸ì¶œí•˜ì—¬ ìµœì¢… ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
         */
        async function runSearchAndAnalysis() {
            // youtubeApiKeyê°€ ê¸°ë³¸ê°’(í•˜ë“œì½”ë”©ëœ í‚¤)ì´ê±°ë‚˜ Firestoreì—ì„œ ë¡œë“œëœ ìœ íš¨í•œ í‚¤ì—¬ì•¼ ê²€ìƒ‰ ì‹¤í–‰
            if (!youtubeApiKey || youtubeApiKey.length < 20) {
                messageBox.textContent = "ğŸš¨ YouTube API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.";
                showApiKeyModal(true);
                return;
            }

            setUIState(true);
            messageBox.textContent = '';
            resultsList.innerHTML = '';
            searchResultsContainer.classList.add('hidden');
            searchVolumeAnalysis.classList.add('hidden');
            translateAllButton.classList.add('hidden'); // ê²€ìƒ‰ ì‹œì‘ ì‹œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°

            const keyword = searchKeywordInput.value.trim();
            currentKeyword = keyword; // í˜„ì¬ í‚¤ì›Œë“œ ì €ì¥
            const sortBy = sortBySelect.value;
            const maxResults = maxResultsSelect.value;
            const videoDurationSelectValue = videoDurationSelect.value;
            const dateRange = dateRangeSelect.value;
            const regionCode = regionCodeSelect.value;
            const minViews = parseInt(minViewsInput.value) || 0;
            const minSubscribers = parseInt(minSubscribersInput.value) || 0; // ìµœì†Œ êµ¬ë…ì ìˆ˜

            if (!keyword) {
                messageBox.textContent = "ğŸš¨ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                setUIState(false);
                return;
            }

            try {
                // --- Step A: ë¶„ì„ ì„¹ì…˜ ì—…ë°ì´íŠ¸ (ë¹„ë™ê¸° ì²˜ë¦¬) ---
                searchVolumeAnalysis.classList.remove('hidden');
                
                // ë‹¤êµ­ì–´ ê°ì§€ ë° ì—°ê´€ í‚¤ì›Œë“œ ìš”ì²­ ì‹œì‘
                const keywordLanguage = await detectKeywordLanguage(keyword);
                const relatedKeywordsPromise = fetchRelatedKeywords(keyword, keywordLanguage);
                
                // ê·¸ë˜í”„ ì´ˆê¸° ë Œë”ë§
                renderSearchTrendGraph(keyword, trendRangeSelect.value);
                // ì—°ê´€ í‚¤ì›Œë“œ ë³¼ë¥¨ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
                updateRelatedKeywordVolumes(trendRangeSelect.value); 
                
                // --- ì œëª© í´ë¦­ ì‹œ ì´ˆê¸°í™” ê¸°ëŠ¥ ë°˜ì˜ì„ ìœ„í•´ ê¸€ë¡œë²Œ íŠ¸ë Œë“œ ì—…ë°ì´íŠ¸ ---
                fetchAndRenderTrends(keyword); 


                // --- Step 1: Search API í˜¸ì¶œ (ì˜ìƒ ID ëª©ë¡ ë° ê¸°ë³¸ ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸°) ---
                let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(keyword)}&type=video&maxResults=${maxResults}&order=${sortBy}&key=${youtubeApiKey}`;
                
                // ìˆì¸  ì œì™¸ ì˜µì…˜ ì²˜ë¦¬ (API level)
                const isShortsExcluded = excludeShortsCheckbox.checked;
                let finalVideoDuration = videoDurationSelectValue;

                // 'ìˆì¸  ì œì™¸ (ì„¸ë¡œ ì˜ìƒ)' ì˜µì…˜ì´ ì²´í¬ëœ ê²½ìš°, Search APIì˜ videoDuration íŒŒë¼ë¯¸í„°ë¥¼ 'medium'ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì§§ì€ ì˜ìƒì´ ë‚˜ì˜¬ í™•ë¥ ì„ ì¤„ì„.
                if (isShortsExcluded) {
                    if (finalVideoDuration === 'any' || finalVideoDuration === 'short') {
                        finalVideoDuration = 'medium'; 
                    }
                }

                if (finalVideoDuration !== 'any') {
                    searchUrl += `&videoDuration=${finalVideoDuration}`;
                }
                
                const publishedAfter = calculatePublishedAfter(dateRange);
                if (publishedAfter) {
                    searchUrl += `&publishedAfter=${publishedAfter}`;
                }
                if (regionCode) {
                    searchUrl += `&regionCode=${regionCode}`;
                }

                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.error) {
                    messageBox.textContent = `Search API ì˜¤ë¥˜: ${searchData.error.message}`;
                    setUIState(false);
                    return;
                }

                if (searchData.items.length === 0) {
                    messageBox.textContent = `âš ï¸ í‚¤ì›Œë“œ "${keyword}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                    setUIState(false);
                    return;
                }

                const videoIds = searchData.items
                    .map(item => item.id.videoId)
                    .filter(id => id); 
                
                const channelIds = searchData.items
                    .map(item => item.snippet.channelId)
                    .filter(id => id);

                if (videoIds.length === 0) {
                     messageBox.textContent = `âš ï¸ í‚¤ì›Œë“œ "${keyword}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.`;
                    setUIState(false);
                    return;
                }

                // --- Step 2: Videos API í˜¸ì¶œ (ì¡°íšŒìˆ˜, ì¢‹ì•„ìš” ìˆ˜, ê¸¸ì´, ìƒì„¸ íƒœê·¸, ëŒ“ê¸€ ìˆ˜, ì¸ë„¤ì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°) ---
                const videoIdsString = videoIds.join(',');
                const videosUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${videoIdsString}&key=${youtubeApiKey}`;

                const videosResponse = await fetch(videosUrl);
                const videosData = await videosResponse.json();

                if (videosData.error) {
                    messageBox.textContent = `Videos API ì˜¤ë¥˜: ${videosData.error.message}`;
                    setUIState(false);
                    return;
                }

                // --- Step 3: Channels API í˜¸ì¶œ (êµ¬ë…ì ìˆ˜, êµ­ê°€ ê°€ì ¸ì˜¤ê¸°) ---
                const uniqueChannelIds = [...new Set(channelIds)];
                const channelsIdsString = uniqueChannelIds.join(',');
                // part=snippet ì¶”ê°€í•˜ì—¬ êµ­ê°€ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const channelsUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelsIdsString}&key=${youtubeApiKey}`;
                
                const channelsResponse = await fetch(channelsUrl);
                const channelsData = await channelsResponse.json();

                if (channelsData.error) {
                    console.error(`Channels API ì˜¤ë¥˜: ${channelsData.error.message}`);
                    // Channels API ì˜¤ë¥˜ëŠ” ê²€ìƒ‰ ì¤‘ë‹¨ ì—†ì´ ê²½ê³ ë§Œ í‘œì‹œ
                }
                
                const channelStats = {};
                if (channelsData.items) {
                    channelsData.items.forEach(channel => {
                        channelStats[channel.id] = {
                            subscribers: parseInt(channel.statistics?.subscriberCount) || 0,
                            country: channel.snippet?.country || 'N/A' // êµ­ê°€ ì •ë³´ ì¶”ì¶œ
                        };
                    });
                }
                
                // --- Step 4: ë°ì´í„° í†µí•© ë° í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ ---
                let finalResults = videosData.items.map(video => {
                    const snippet = video.snippet || {};
                    const statistics = video.statistics || {};
                    const contentDetails = video.contentDetails || {};
                    const channelId = snippet.channelId;
                    const stats = channelStats[channelId] || {};

                    // ì¸ë„¤ì¼ ì •ë³´ ì¶”ì¶œ (ìˆì¸  í•„í„°ë§ì„ ìœ„í•´ width/height í•„ìš”)
                    const thumbnailMedium = snippet.thumbnails?.medium || { url: '', width: 320, height: 180 };


                    return {
                        id: video.id,
                        title: snippet.title,
                        publishedAt: snippet.publishedAt,
                        channelTitle: snippet.channelTitle,
                        channelId: channelId,
                        subscriberCount: stats.subscribers || 0,
                        channelCountry: stats.country || 'N/A', // êµ­ê°€ ì •ë³´ ì¶”ê°€
                        tags: snippet.tags || [],
                        thumbnailUrl: thumbnailMedium.url,
                        thumbnailWidth: thumbnailMedium.width,
                        thumbnailHeight: thumbnailMedium.height,
                        viewCount: parseInt(statistics.viewCount) || 0,
                        likeCount: parseInt(statistics.likeCount) || 0,
                        commentCount: parseInt(statistics.commentCount) || 0, // ëŒ“ê¸€ ìˆ˜ ì¶”ê°€
                        duration: contentDetails.duration, // ISO 8601 ì›ë³¸ ìœ ì§€
                        durationFormatted: formatDuration(contentDetails.duration), // í¬ë§·ëœ ê¸¸ì´
                        description: snippet.description || "ì˜ìƒ ì„¤ëª…ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." 
                    };
                });
                
                // ìµœì†Œ ì¡°íšŒìˆ˜, ìµœì†Œ êµ¬ë…ì ìˆ˜, ìˆì¸  ì œì™¸ í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ ì ìš©
                let filteredResults = finalResults.filter(video => {
                    // 1. ìµœì†Œ ì¡°íšŒìˆ˜ í•„í„°ë§
                    if (video.viewCount < minViews) return false;
                    
                    // 2. ìµœì†Œ êµ¬ë…ì ìˆ˜ í•„í„°ë§
                    if (video.subscriberCount < minSubscribers) return false;

                    // 3. ìˆì¸  ì œì™¸ (ì„¸ë¡œ ì˜ìƒ) í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§
                    if (isShortsExcluded) {
                        // ì¸ë„¤ì¼ ë„ˆë¹„ê°€ ë†’ì´ë³´ë‹¤ ì‘ìœ¼ë©´ (ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ì´ 1ë³´ë‹¤ ì‘ìœ¼ë©´) ì„¸ë¡œ ì˜ìƒìœ¼ë¡œ ê°„ì£¼
                        if (video.thumbnailWidth && video.thumbnailHeight && video.thumbnailWidth < video.thumbnailHeight) {
                            return false; // ìˆì¸ (ì„¸ë¡œ ì˜ìƒ) ì œì™¸
                        }
                    }

                    return true;
                });
                
                // --- Step 5: ê²°ê³¼ ë Œë”ë§ ---
                renderResults(filteredResults, keyword);

                // ì—°ê´€ í‚¤ì›Œë“œ ìš”ì²­ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
                await relatedKeywordsPromise;


            } catch (error) {
                console.error("Search/Analysis Error:", error);
                messageBox.textContent = "ğŸ˜­ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.";
            } finally {
                setUIState(false);
            }
        }

        /**
         * ì—°ê´€ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ Gemini APIë¥¼ í†µí•´ ê°€ì ¸ì™€ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        async function fetchRelatedKeywords(keyword, keywordLanguage) {
            relatedKeywordsLoading.classList.remove('hidden');
            relatedKeywordsList.innerHTML = '';
            
            // ë‹¤êµ­ì–´ ìš°ì„ ìˆœìœ„ë¥¼ ë°˜ì˜í•œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
            const systemPrompt = `You are an SEO and content strategy expert. The user's primary keyword is in ${keywordLanguage}. Generate a list of 20 high-value, long-tail related search queries/keywords that are relevant to YouTube video content. The keywords must be in ${keywordLanguage} (or English if the primary language is not suitable for search). Respond only with a comma-separated list of the 20 keywords, with no prefix, suffix, or explanation.`;
            const userPrompt = `Generate 20 related search keywords for YouTube based on the primary keyword: "${keyword}"`;

            try {
                const resultText = await callGeminiApi(userPrompt, systemPrompt);

                // ê²°ê³¼ í…ìŠ¤íŠ¸ë¥¼ ì‰¼í‘œë¡œ ë¶„ë¦¬í•˜ì—¬ ìµœëŒ€ 20ê°œì˜ í‚¤ì›Œë“œ ë°°ì—´ ìƒì„±
                const keywords = resultText.split(',').map(k => k.trim()).filter(k => k.length > 1).slice(0, 20);

                if (keywords.length > 0) {
                    keywords.forEach(key => {
                        const simulatedVolume = generateSimulatedVolume(key, trendRangeSelect.value);
                        const keywordHtml = `
                            <button 
                                class="tag-search-btn bg-blue-500 text-white text-xs font-semibold px-3 py-1 rounded-full hover:bg-blue-600 transition duration-150 active:scale-95 flex items-center group" 
                                data-tag-value="${key.replace(/"/g, '&quot;')}"
                                data-keyword-volume="${simulatedVolume}"
                                title="í´ë¦­í•˜ì—¬ ì—°ê´€ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰"
                            >
                                ${key} 
                                <span class="ml-2 font-bold text-yellow-300 group-hover:text-yellow-200 transition duration-150 text-xs">
                                    ${formatNumber(simulatedVolume)}íšŒ
                                </span>
                            </button>
                        `;
                        relatedKeywordsList.insertAdjacentHTML('beforeend', keywordHtml);
                    });
                } else {
                    relatedKeywordsList.innerHTML = '<span class="text-gray-500">ì—°ê´€ í‚¤ì›Œë“œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</span>';
                }

            } catch (error) {
                relatedKeywordsList.innerHTML = `<span class="text-red-500">${error}</span>`;
            } finally {
                relatedKeywordsLoading.classList.add('hidden');
            }
        }


        /**
         * ê²€ìƒ‰ ê²°ê³¼ë¥¼ HTML ë¦¬ìŠ¤íŠ¸ë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {Array<Object>} videos - í•„í„°ë§ëœ ì˜ìƒ ë°ì´í„° ë°°ì—´
         * @param {string} keyword - ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê²€ìƒ‰ í‚¤ì›Œë“œ
         */
        function renderResults(videos, keyword) {
            resultsList.innerHTML = ''; // ê¸°ì¡´ ê²°ê³¼ ì§€ìš°ê¸°
            searchResultsContainer.classList.remove('hidden');
            resultCountHeader.textContent = `ê²€ìƒ‰ ê²°ê³¼ (${formatNumber(videos.length)}ê°œ)`;
            
            // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆì„ ê²½ìš°ì—ë§Œ ì „ì²´ ë²ˆì—­ ë²„íŠ¼ í‘œì‹œ
            if (videos.length > 0) {
                 translateAllButton.classList.remove('hidden');
            } else {
                translateAllButton.classList.add('hidden');
                resultsList.innerHTML = '<p class="text-gray-500 p-4 bg-white rounded-lg shadow-md">ì ìš©ëœ í•„í„° ì¡°ê±´ì— ë§ëŠ” ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            const searchTerms = keyword.toLowerCase().split(/\s+/).filter(t => t.length > 0);

            videos.forEach(video => {
                const videoLink = `https://www.youtube.com/watch?v=${video.id}`;
                const publishedDate = new Date(video.publishedAt).toLocaleDateString('ko-KR');
                const rawTagsString = video.tags.join(', '); // ë³µì‚¬ìš© ì‰¼í‘œ êµ¬ë¶„ ë¬¸ìì—´
                
                const channelLink = `https://www.youtube.com/channel/${video.channelId}`; // ì±„ë„ ë§í¬
                
                // êµ­ê°€ ì½”ë“œ -> ë‹¨ì¶•ì–´ (2ìë¦¬ ì½”ë“œ) ì‚¬ìš©
                const countryCode = video.channelCountry;
                const countryDisplay = countryCode !== 'N/A' ? `<span class="text-gray-500 font-medium ml-1">(${countryCode})</span>` : ''; // êµ­ê°€ í‘œì‹œ (2ìë¦¬ ì½”ë“œ)
                
                const subCountDisplay = video.subscriberCount > 0 
                    ? `<span class="text-xs text-red-500 font-bold ml-2">(${formatNumber(video.subscriberCount)} êµ¬ë…ì)</span>` 
                    : '';

                // 1. íƒœê·¸ ëª©ë¡ ìƒì„± ë° ìˆœìœ„ ê³„ì‚° (CRITICAL)
                let tagsHtml = video.tags.map((tag, index) => {
                    const tagLower = tag.toLowerCase();
                    let rankBadge = '';
                    
                    // ê²€ìƒ‰ í‚¤ì›Œë“œì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
                    for (const term of searchTerms) {
                        if (tagLower.includes(term)) {
                            // 1ë¶€í„° ì‹œì‘í•˜ëŠ” ìˆœìœ„ í‘œì‹œ (ë°°ê²½ìƒ‰ ì œê±°, ìŠ¤íƒ€ì¼ í†µí•©)
                            rankBadge = `<span class="ml-1 text-red-600 font-bold">(ìˆœìœ„: ${index + 1})</span>`;
                            break; // ì²« ë²ˆì§¸ ì¼ì¹˜í•˜ëŠ” í‚¤ì›Œë“œë§Œ ìˆœìœ„ í‘œì‹œ
                        }
                    }
                    // íƒœê·¸ ë²„íŠ¼ì— ìˆœìœ„ ë°°ì§€ë¥¼ í¬í•¨í•˜ì—¬ ë Œë”ë§í•©ë‹ˆë‹¤.
                    // whitespace-nowrapì„ ì‚¬ìš©í•˜ì—¬ íƒœê·¸ì™€ ìˆœìœ„ê°€ í•œ ë²„íŠ¼ ì•ˆì—ì„œ ì¤„ë°”ê¿ˆë˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤.
                    return `
                        <button class="tag-search-btn bg-gray-200 text-gray-700 text-xs font-medium px-2 py-1 rounded-md inline-flex items-center mr-2 mb-1 hover:bg-blue-300 transition duration-150 active:scale-95 whitespace-nowrap" data-tag-value="${tag.replace(/"/g, '&quot;')}" title="í´ë¦­í•˜ì—¬ íƒœê·¸ë¡œ ê²€ìƒ‰">
                            ${tag}${rankBadge}
                        </button>`;
                }).join('');

                const copyButtonHtml = video.tags.length > 0 ? `
                    <button 
                        class="copy-tags-btn bg-green-500 text-white text-xs font-semibold px-2 py-1 rounded hover:bg-green-600 transition duration-150 active:scale-95"
                        data-tags="${rawTagsString.replace(/"/g, '&quot;')}" 
                        title="ëª¨ë“  íƒœê·¸ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ë³µì‚¬í•©ë‹ˆë‹¤."
                    >
                        ğŸ”— íƒœê·¸ ì „ì²´ ë³µì‚¬
                    </button>
                ` : '';

                const videoCard = `
                    <div id="video-${video.id}" class="bg-white p-4 rounded-xl shadow-lg flex flex-col md:flex-row gap-4 border-l-4 border-blue-500 hover:shadow-xl transition duration-200">
                        
                        <!-- ì¸ë„¤ì¼ ë° ê¸¸ì´ (ì¢Œì¸¡) -->
                        <div class="relative w-full md:w-56 flex-shrink-0">
                            <a href="${videoLink}" target="_blank" rel="noopener noreferrer">
                                <img src="${video.thumbnailUrl}" alt="${video.title}" class="w-full h-auto rounded-lg shadow-md object-cover">
                            </a>
                            <span class="duration-overlay">${video.durationFormatted}</span>
                        </div>

                        <!-- ë‚´ìš© (ìš°ì¸¡) -->
                        <div class="flex-grow">
                            <!-- ì œëª© -->
                            <div class="flex items-center mb-1">
                                <h3 id="title-${video.id}" class="video-title text-lg font-bold text-gray-900 line-clamp-2 mr-2" data-original-title="${video.title.replace(/"/g, '&quot;')}">
                                    <a href="${videoLink}" target="_blank" rel="noopener noreferrer" class="hover:text-blue-600 transition duration-150">${video.title}</a>
                                </h3>
                                <!-- ë²ˆì—­ ë²„íŠ¼ -->
                                <button data-id="${video.id}" data-type="translate" data-title="${video.title.replace(/"/g, '&quot;')}" class="action-btn text-xs bg-gray-100 text-gray-600 hover:bg-blue-500 hover:text-white font-semibold py-1 px-2 rounded-full transition duration-150 active:scale-95 flex items-center">
                                    <span class="action-text">ë²ˆì—­</span>
                                </button>
                                <!-- ìš”ì•½ ë²„íŠ¼ -->
                                <button data-id="${video.id}" data-type="summary" data-description="${video.description.replace(/"/g, '&quot;')}" class="action-btn text-xs bg-gray-100 text-gray-600 hover:bg-blue-500 hover:text-white font-semibold py-1 px-2 rounded-full ml-1 transition duration-150 active:scale-95 flex items-center">
                                    <span class="action-text">ìš”ì•½</span>
                                </button>
                            </div>
                            
                            <!-- ì±„ë„ëª… ë° ë‚ ì§œ -->
                            <p class="text-sm text-blue-600 font-medium mb-2">
                                <a href="${channelLink}" target="_blank" rel="noopener noreferrer" class="hover:underline">${video.channelTitle}</a> ${countryDisplay} ${subCountDisplay} Â· ${publishedDate} ì—…ë¡œë“œ
                            </p>

                            <!-- í†µê³„ (ì¡°íšŒìˆ˜, ì¢‹ì•„ìš”, ëŒ“ê¸€ ìˆ˜) -->
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm mb-3">
                                <span class="font-semibold text-gray-700">
                                    ì¡°íšŒìˆ˜: <span class="text-green-600">${formatNumber(video.viewCount)}</span>íšŒ
                                </span>
                                <span class="font-semibold text-gray-700">
                                    ì¢‹ì•„ìš”: <span class="text-red-500">${formatNumber(video.likeCount)}</span>ê°œ
                                </span>
                                <span class="font-semibold text-gray-700">
                                    ëŒ“ê¸€ ìˆ˜: <span class="text-indigo-600">${formatNumber(video.commentCount)}</span>ê°œ
                                </span>
                            </div>
                            
                            <!-- ìš”ì•½/ë²ˆì—­ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
                            <div id="result-area-${video.id}" class="hidden mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-gray-800">
                                <div id="result-content-${video.id}"></div>
                            </div>


                            <!-- íƒœê·¸ ëª©ë¡ ë° ë³µì‚¬ ë²„íŠ¼ -->
                            <div class="mt-2 pt-2 border-t border-gray-100">
                                <div class="flex items-center justify-between mb-1">
                                    <p class="text-xs font-semibold text-gray-500">íƒœê·¸ (${video.tags.length}ê°œ):</p>
                                    ${copyButtonHtml}
                                </div>
                                <div class="flex flex-wrap items-center">
                                    ${tagsHtml || '<span class="text-xs text-gray-400">íƒœê·¸ ì •ë³´ ì—†ìŒ</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                resultsList.insertAdjacentHTML('beforeend', videoCard);
            });
        }

        // =================================================================
        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (Gemini API í˜¸ì¶œ)
        // =================================================================
        
        async function handleActionClick(button) {
            const videoId = button.dataset.id;
            const type = button.dataset.type;
            const resultArea = document.getElementById(`result-area-${videoId}`);
            const resultContent = document.getElementById(`result-content-${videoId}`);
            const actionText = button.querySelector('.action-text');

            // í† ê¸€ ë¡œì§: ì´ë¯¸ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ê¸°
            if (!resultArea.classList.contains('hidden') && button.dataset.currentType === type) {
                resultArea.classList.add('hidden');
                button.dataset.currentType = '';
                return;
            }
            
            // ë¡œë”© ìƒíƒœ ì‹œì‘
            const originalText = actionText.textContent;
            actionText.innerHTML = '<div class="spinner-sm"></div>';
            button.disabled = true;

            resultArea.classList.remove('hidden');
            resultContent.innerHTML = `<p class="text-gray-500">ìš”ì²­ ì¤‘...</p>`;
            
            let result = '';
            let systemPrompt = '';
            let userPrompt = '';
            
            if (type === 'translate') {
                const title = button.dataset.title;
                systemPrompt = "You are a professional Korean translator. Translate the given text naturally and concisely into Korean, outputting only the translated title.";
                userPrompt = `Translate the following YouTube video title into Korean: "${title}"`;
                result = await callGeminiApi(userPrompt, systemPrompt);
                
                resultContent.innerHTML = `<p class="font-bold mb-1">ì œëª© ë²ˆì—­ ê²°ê³¼:</p><p class="whitespace-pre-wrap">${result}</p>`;
            } else if (type === 'summary') {
                const description = button.dataset.description;
                
                if (description === "ì˜ìƒ ì„¤ëª…ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." || description.trim().length < 10) {
                    result = "ì˜ìƒì˜ ì„¤ëª…ì´ ë„ˆë¬´ ì§§ê±°ë‚˜ ì œê³µë˜ì§€ ì•Šì•„ ìš”ì•½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìš”ì•½ì€ ì˜ìƒì˜ ì„¤ëª…(Description)ì„ ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤.)";
                } else {
                    // ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ìš”ì•½ ê¸¸ì´ë¥¼ 5~8 ë¬¸ì¥ ê¸¸ì´ì˜ ë‹¨ë½ìœ¼ë¡œ ëŠ˜ë¦¼ (ìµœëŒ€ 10ì¤„ ì´ë‚´)
                    systemPrompt = "You are a professional video content summarizer. Summarize the provided text (video description) into a concise paragraph of 5 to 8 sentences in Korean. Output only the summarized paragraph.";
                    userPrompt = `ë‹¤ìŒ YouTube ì˜ìƒ ì„¤ëª…(Description)ì„ í•œêµ­ì–´ë¡œ 5~8 ë¬¸ì¥ ê¸¸ì´ì˜ ë‹¨ë½ìœ¼ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”:\n\n---\n\n${description}`;
                    result = await callGeminiApi(userPrompt, systemPrompt);
                }

                // ë‹¨ë½ ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½í•˜ì—¬ ê¸´ ìš”ì•½ì— ëŒ€ì‘
                resultContent.innerHTML = `<p class="font-bold mb-1">ì„¤ëª… ìš”ì•½ ê²°ê³¼:</p><p class="whitespace-pre-wrap">${result}</p>`;
            }

            // ë¡œë”© ìƒíƒœ ì¢…ë£Œ
            actionText.textContent = originalText;
            button.disabled = false;
            button.dataset.currentType = type; // í˜„ì¬ í™œì„±í™”ëœ íƒ€ì… ê¸°ë¡
        }
        
        /**
         * ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡ì˜ ëª¨ë“  ì œëª©ì„ ì¼ê´„ì ìœ¼ë¡œ ë²ˆì—­í•©ë‹ˆë‹¤.
         */
        async function handleTranslateAllTitles() {
            const titleElements = document.querySelectorAll('.video-title');
            
            if (titleElements.length === 0) {
                messageBox.textContent = "ğŸš¨ ë²ˆì—­í•  ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            
            translateAllButton.disabled = true;
            translateAllText.innerHTML = '<div class="spinner-sm border-white border-l-transparent"></div>';
            messageBox.textContent = ''; // Clear previous messages
            
            const systemPrompt = "You are a professional Korean translator. Translate the given text naturally and concisely into Korean, outputting only the translated title.";
            
            // **ìˆ˜ì •ëœ ë¡œì§: 10/ë¶„ í• ë‹¹ëŸ‰ ì´ˆê³¼ë¥¼ ë§‰ê¸° ìœ„í•´ ìˆœì°¨ì  ì²˜ë¦¬ ë° ì§€ì—° ì‹œê°„ ì ìš©**
            const DELAY_MS = 6500; // 6.5ì´ˆ ì§€ì—° (60ì´ˆ/10íšŒ ì œí•œ ì¤€ìˆ˜)
            let successfulTranslations = 0;
            let lastError = null;

            for (let i = 0; i < titleElements.length; i++) {
                const titleElement = titleElements[i];
                const originalTitle = titleElement.dataset.originalTitle;
                const userPrompt = `Translate the following YouTube video title into Korean: "${originalTitle}"`;
                
                // ì§„í–‰ ìƒí™© í‘œì‹œ
                translateAllText.textContent = `ë²ˆì—­ ì¤‘... (${i + 1}/${titleElements.length})`;

                const translatedTitle = await callGeminiApi(userPrompt, systemPrompt);
                
                // ê²°ê³¼ ì²˜ë¦¬
                const titleLink = titleElement.querySelector('a');
                if (titleLink) {
                    if (!translatedTitle.startsWith('[API ì˜¤ë¥˜')) {
                        // ì„±ê³µì ìœ¼ë¡œ ë²ˆì—­ë˜ì—ˆì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
                        titleLink.textContent = translatedTitle;
                        successfulTranslations++;
                    } else {
                        // API ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë¡ ë° ì§„í–‰
                        lastError = translatedTitle;
                        console.error(`Translation failed for: ${originalTitle}. Error: ${translatedTitle}`);
                        // ì¿¼í„° ì´ˆê³¼ ì˜¤ë¥˜ì¸ ê²½ìš°, ì´í›„ ìš”ì²­ì„ ì¤‘ë‹¨í•˜ê³  ë©”ì‹œì§€ í‘œì‹œ
                        if (translatedTitle.includes('Quota exceeded')) {
                            break; 
                        }
                    }
                }
                
                // ë§ˆì§€ë§‰ ìš”ì²­ì´ ì•„ë‹ˆë©´ ì§€ì—° ì‹œê°„ì„ ì ìš©í•˜ì—¬ í• ë‹¹ëŸ‰ ì´ˆê³¼ë¥¼ ë°©ì§€
                if (i < titleElements.length - 1 && successfulTranslations === i + 1) {
                    await new Promise(resolve => setTimeout(resolve, DELAY_MS));
                }
            }

            // ìµœì¢… ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            if (successfulTranslations === titleElements.length) {
                messageBox.textContent = `âœ… ${successfulTranslations}ê°œ ì œëª© ë²ˆì—­ì„ ëª¨ë‘ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.`;
            } else if (successfulTranslations > 0) {
                 messageBox.textContent = `âš ï¸ ${successfulTranslations}ê°œ ì œëª©ì„ ë²ˆì—­í–ˆìŠµë‹ˆë‹¤. ë‚˜ë¨¸ì§€ (${titleElements.length - successfulTranslations}ê°œ)ëŠ” ì˜¤ë¥˜ ë˜ëŠ” í• ë‹¹ëŸ‰ ì´ˆê³¼ë¡œ ì¸í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.`;
            } else {
                 messageBox.textContent = `âŒ ì œëª© ë²ˆì—­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ${lastError || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}. API í• ë‹¹ëŸ‰ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.`;
            }

            // Restore button state
            translateAllText.textContent = 'ì œëª© ì „ì²´ ë²ˆì—­';
            translateAllButton.disabled = false;
        }
        
        // =================================================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        // =================================================================

        // ì œëª© í´ë¦­ ì‹œ ì´ˆê¸°í™” (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨)
        mainTitle.addEventListener('click', () => {
            location.reload();
        });


        // 1. ê²€ìƒ‰ ë²„íŠ¼
        searchButton.addEventListener('click', runSearchAndAnalysis);
        searchKeywordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                runSearchAndAnalysis();
            }
        });
        
        // 2. ê²€ìƒ‰ëŸ‰ ì¶”ì´ ë²”ìœ„ ë³€ê²½ ë²„íŠ¼ (ê²€ìƒ‰ í›„ ê·¸ë˜í”„)
        trendRangeSelect.addEventListener('change', () => {
            const newRange = trendRangeSelect.value;
            if (currentKeyword) {
                // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                renderSearchTrendGraph(currentKeyword, newRange);
                // ì—°ê´€ í‚¤ì›Œë“œ ë³¼ë¥¨ ì—…ë°ì´íŠ¸
                updateRelatedKeywordVolumes(newRange); 
            }
        });
        
        // 3. ê¸€ë¡œë²Œ íŠ¸ë Œë“œ í•„í„° ë³€ê²½ (ê¸°ê°„ ë° êµ­ê°€)
        dateRangeSelect.addEventListener('change', () => {
             // í•„í„° ë³€ê²½ ì‹œ í˜„ì¬ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¸ë Œë“œ ì—…ë°ì´íŠ¸
            fetchAndRenderTrends(currentKeyword);
        });
        regionCodeSelect.addEventListener('change', () => {
            // í•„í„° ë³€ê²½ ì‹œ í˜„ì¬ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¸ë Œë“œ ì—…ë°ì´íŠ¸
            fetchAndRenderTrends(currentKeyword);
        });

        // 4. ì œëª© ì „ì²´ ë²ˆì—­ ë²„íŠ¼
        translateAllButton.addEventListener('click', handleTranslateAllTitles);


        // 5. ëª¨ë‹¬ ì €ì¥ ë²„íŠ¼
        saveApiKeyButton.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            if (key.length < 20) { 
                modalMessage.textContent = "ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                modalMessage.classList.remove('hidden');
                return;
            }
            saveApiKey(key);
        });

        // 6. íƒœê·¸ ë³µì‚¬, ë²ˆì—­, ìš”ì•½, íƒœê·¸ ê²€ìƒ‰ ë²„íŠ¼ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
        resultsList.addEventListener('click', (event) => {
            // íƒœê·¸ ë³µì‚¬ ë²„íŠ¼ ì²˜ë¦¬
            const copyButton = event.target.closest('.copy-tags-btn');
            if (copyButton) {
                const tagsString = copyButton.dataset.tags;
                if (tagsString) {
                    copyTagsToClipboard(tagsString, copyButton);
                }
                return;
            }
            
            // ë²ˆì—­/ìš”ì•½ ë²„íŠ¼ ì²˜ë¦¬
            const actionButton = event.target.closest('.action-btn');
            if (actionButton) {
                handleActionClick(actionButton);
            }

            // íƒœê·¸ ê²€ìƒ‰ ë²„íŠ¼ ì²˜ë¦¬ (ìƒˆë¡œìš´ ê¸°ëŠ¥)
            const tagButton = event.target.closest('.tag-search-btn');
            if (tagButton) {
                const tagValue = tagButton.dataset.tagValue;
                if (tagValue) {
                    searchKeywordInput.value = tagValue; // ê²€ìƒ‰ í‚¤ì›Œë“œ í•„ë“œì— íƒœê·¸ ê°’ ì„¤ì •
                    runSearchAndAnalysis(); // ê²€ìƒ‰ ì‹¤í–‰
                }
            }
        });
        
        // 7. ì—°ê´€ í‚¤ì›Œë“œ ë²„íŠ¼ ì²˜ë¦¬ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
        searchVolumeAnalysis.addEventListener('click', (event) => {
            const tagButton = event.target.closest('.tag-search-btn');
            if (tagButton) {
                const tagValue = tagButton.dataset.tagValue;
                if (tagValue) {
                    searchKeywordInput.value = tagValue; // ê²€ìƒ‰ í‚¤ì›Œë“œ í•„ë“œì— íƒœê·¸ ê°’ ì„¤ì •
                    runSearchAndAnalysis(); // ê²€ìƒ‰ ì‹¤í–‰
                }
            }
        });
        
        // 8. ê¸€ë¡œë²Œ íŠ¸ë Œë“œ í‚¤ì›Œë“œ í´ë¦­ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
        youtubeTrendsDashboard.addEventListener('click', (event) => {
            const trendItem = event.target.closest('.trend-item');
            if (trendItem) {
                const keyword = trendItem.dataset.tagValue;
                if (keyword) {
                    searchKeywordInput.value = keyword;
                    runSearchAndAnalysis();
                }
            }
        });

        
        // 9. ì´ˆê¸°í™”
        window.addEventListener('load', initializeFirebase);
    </script>
</body>
</html>
